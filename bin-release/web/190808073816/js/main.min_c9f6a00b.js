var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function a(t){try{h(i.next(t))}catch(e){o(e)}}function s(t){try{h(i["throw"](t))}catch(e){o(e)}}function h(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(a,s)}h((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return i([t,e])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,o&&(a=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,o=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){h.label=n[1];break}if(6===n[0]&&h.label<a[1]){h.label=a[1],a=n;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(n);break}a[2]&&h.ops.pop(),h.trys.pop();continue}n=e.call(t,h)}catch(i){n=[6,i],o=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,o,a,s,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,n){function i(i){e.call(n,i,t)}if(RES.hasRes(t)){var r=RES.getRes(t);r?i(r):RES.getResAsync(t,i,this)}else RES.getResByUrl(t,i,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),cm.init(this),egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var e=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",e),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.loadResource()];case 1:return t.sent(),this.createGameScene(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,this.loadTheme()];case 2:return n.sent(),[4,RES.loadGroup("preload",0,t)];case 3:return n.sent(),this.stage.removeChild(t),[3,5];case 4:return e=n.sent(),console.error(e),[3,5];case 5:return[2]}})})},e.prototype.loadTheme=function(){var t=this;return new Promise(function(e,n){var i=new eui.Theme("resource/default.thm.json",t.stage);i.addEventListener(eui.UIEvent.COMPLETE,function(){e()},t)})},e.prototype.createGameScene=function(){cm.sceneManager.load(views.MainScene)},e}(eui.UILayer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,n,i){function r(t){e.call(i,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),n.call(i))}var a=this;if("undefined"!=typeof generateEUI)egret.callLater(function(){e.call(i,generateEUI)},this);else if("undefined"!=typeof generateEUI2)RES.getResByUrl("resource/gameEui.json",function(t,n){window.JSONParseClass.setData(t),egret.callLater(function(){e.call(i,generateEUI2)},a)},this,RES.ResourceItem.TYPE_JSON);else if("undefined"!=typeof generateJSON)if(t.indexOf(".exml")>-1){var s=t.split("/");s.pop();var h=s.join("/")+"_EUI.json";generateJSON.paths[t]?egret.callLater(function(){e.call(i,generateJSON.paths[t])},this):RES.getResByUrl(h,function(n){window.JSONParseClass.setData(n),egret.callLater(function(){e.call(i,generateJSON.paths[t])},a)},this,RES.ResourceItem.TYPE_JSON)}else egret.callLater(function(){e.call(i,generateJSON)},this);else RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,r,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var modle;!function(t){var e=15,n=50,i=10,r=30,o=function(t,e){return t+Math.floor(Math.random()*e)},a=function(){function t(t){this._num=t,this._init()}return t.prototype._init=function(){this._martix=[],this._martix[0]=[0,50];var t=this._generateMartix(this._num-1,this._martix[0]);this._martix=this._martix.concat(t)},t.prototype.addMartix=function(t){var e=this._martix[this._num-1];this._num+=t;var n=this._generateMartix(t,e);return this._martix=this._martix.concat(n),n},t.prototype._generateMartix=function(t,a){void 0===a&&(a=[]);for(var s=[],h=a,c=0;t>c;c++){var u=[];h[1]?u[0]=h[1]+o(i,r):u[0]=0,u[1]=u[0]+o(e,n),h=u,s.push(u)}return s},t.prototype.getMartix=function(){return this._martix},t.prototype.getStart=function(t){return this._martix[t][0]},t.prototype.getEnd=function(t){return this._martix[t][1]},t}();t.Floor=a,__reflect(a.prototype,"modle.Floor")}(modle||(modle={}));var modle;!function(t){var e=20,n=1e3,i=function(t){function e(e,n){return t.call(this,e,!1,!1,n)||this}return __extends(e,t),e.ON_PROGRESS="on_progress",e.ON_COMPLETE="on_complete",e}(egret.Event);t.TouchCaptureEvent=i,__reflect(i.prototype,"modle.TouchCaptureEvent");var r=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.bindNode=function(t,e){this._node&&(this._node.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this._touchStartHandler,this),this._node.removeEventListener(egret.TouchEvent.TOUCH_END,this._touchEndHandler,this)),this._init(t,e)},r.prototype._init=function(t,e){this._node=t,this._startTouchHandlerListener()},r.prototype._startTouchHandlerListener=function(){this._node&&(this._node.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this._touchStartHandler,this),this._node.addEventListener(egret.TouchEvent.TOUCH_END,this._touchEndHandler,this))},r.prototype._touchStartHandler=function(){var t=this;this._startTime=Date.now(),this._timer=setInterval(function(){var e=Date.now(),r=e-t._startTime;t.dispatchEvent(new i(i.ON_PROGRESS,Math.floor(r/n*100))),r>=n&&(t.dispatchEvent(new i(i.ON_COMPLETE,Math.floor(r/n*100))),clearInterval(t._timer))},e)},r.prototype._touchEndHandler=function(){var t=Date.now(),e=t-this._startTime;this.dispatchEvent(new i(i.ON_COMPLETE,Math.floor(e/n*100))),clearInterval(this._timer)},r}(egret.EventDispatcher);t.TouchCapture=r,__reflect(r.prototype,"modle.TouchCapture")}(modle||(modle={}));var views;!function(t){var e;!function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT"}(e=t.CharacterDirection||(t.CharacterDirection={}));var n=function(t){function n(n,i,r,o){void 0===r&&(r=.5),void 0===o&&(o=1);var a=t.call(this)||this;return a.moveSpeed=200,a._leftDirectionXscale=1,a._direction=e.NONE,a._name="",a._username="",a.onMoveCallback=null,a._idleOptions=null,a._timer=null,a.anchorX=.5,a.anchorY=1,a.anchorX=r,a.anchorY=o,a._name=n,a._username=i,a.loadRes(),a}return __extends(n,t),n.prototype.loadRes=function(){var t="animation_"+this._name;RES.createGroup(t,[this._name+"_ske_json",this._name+"_tex_json",this._name+"_tex_png"],!0),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResComplete,this),RES.loadGroup(t)},n.prototype.onResComplete=function(t){t.groupName==="animation_"+this._name&&(this.createAnimation(),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResComplete,this),this.callback&&this.callback())},n.prototype.createAnimation=function(){var t=RES.getRes(this._name+"_ske_json"),e=RES.getRes(this._name+"_tex_json"),n=RES.getRes(this._name+"_tex_png"),i=cm.dragonBonesManager.getFactory(this._name,t,e,n),r=i.buildArmatureDisplay("armatureName");this._armature=r,this.addChild(this._armature);var o=this._armature.width,a=this._armature.height;this.anchorOffsetX=o*this.anchorX,this.anchorOffsetY=a*this.anchorY,this.width=o,this.height=a,this._armature.x=o/2,this._armature.y=a,this.updateDirection(),this.idle(),this._armature.addEventListener(dragonBones.EventObject.COMPLETE,this.playAnimationComplete,this)},n.prototype.onRemove=function(){t.prototype.onRemove.call(this),this.stopRandomPlay(),this._armature&&this._armature.removeEventListener(dragonBones.EventObject.COMPLETE,this.playAnimationComplete,this)},n.prototype.playAnimationComplete=function(t){var e=t.animationState.name;egret.log(e+" complete"),this._idleOptions&&-1!==this._idleOptions.actions.indexOf(e)&&this.idle(),"win"===e&&this.idle()},n.prototype.startRandomPlay=function(){this._timer||(this._timer=new egret.Timer(this._idleOptions.interval)),this._timer.addEventListener(egret.TimerEvent.TIMER,this.onTimer,this),this._timer.start()},n.prototype.onTimer=function(){if(this._armature){var t=this._armature.animation.getState("idle");t&&t.isPlaying&&Math.random()<this._idleOptions.rate&&this.playRandomAction()}},n.prototype.stopRandomPlay=function(){this._timer&&(this._timer.removeEventListener(egret.TimerEvent.TIMER,this.onTimer,this),this._timer.stop())},n.prototype.playRandomAction=function(){var t=this._idleOptions.actions.length,e=Math.floor(Math.random()*t),n=this._idleOptions.actions[e];this.play(n,1)},n.prototype.randomPlayWhenIdle=function(t){this._idleOptions=t,this.startRandomPlay()},n.prototype.walkTo=function(t){var n=this;if(this._armature){this.walk(),egret.Tween.removeTweens(this);var i=egret.Tween.get(this,{onChange:this.onChange,onChangeObj:this}),r=new egret.Point(this.x,this.y),o=egret.Point.distance(r,t),a=o/this.moveSpeed*1e3;t.x>this.x?this.setDirection(e.RIGHT):this.setDirection(e.LEFT);var s=new Promise(function(e,r){i.to({x:t.x,y:t.y},a).call(function(){e(),n.idle()})});return s}},n.prototype.setDirection=function(t){this._direction=t,this.updateDirection()},n.prototype.updateDirection=function(){this._armature&&(this._direction===e.LEFT?this._armature.scaleX=1*this._leftDirectionXscale:this._direction===e.RIGHT&&(this._armature.scaleX=-1*this._leftDirectionXscale))},n.prototype.onChange=function(){this.onMoveCallback&&this.onMoveCallback()},n.prototype.idle=function(){this.play("idle",0)},n.prototype.walk=function(){this.play("walk",0)},n.prototype.win=function(t){this.play("win",3)},n.prototype.yawn=function(){this.play("yawn")},n.prototype.pause=function(){this._armature&&this._armature.animation.gotoAndStop("idle")},n.prototype.play=function(t,e){if(this._armature){var n=this._armature.animation.getState(t);n&&n.isPlaying||this._armature.animation.play(t,e)}},n}(cm.EUIComponent);t.Character=n,__reflect(n.prototype,"views.Character")}(views||(views={}));var views;!function(t){var e=.5,n=100,i=40,r=function(r){function o(t){var e=r.call(this,t)||this;return e._currentPosition=0,e._currentPoint=0,e._currentMartix=0,e._count=0,e._progress=50,e._isComeDown=!1,e.skinName="resource/views/MainScene.exml",e}return __extends(o,r),o.prototype.onComplete=function(){r.prototype.onComplete.call(this),this._init()},o.prototype._init=function(){var t=this;this._martixFloor=new modle.Floor(10);var e=this._martixFloor.getMartix();this._currentPoint=this._martixFloor.getEnd(this._currentMartix),this._generateFloors(e),this._addCharacter(),cm.Utils.delay(500,function(){t._addTouchHandler()})},o.prototype._reStart=function(){this._currentMartix=0,this._currentPosition=0,this._count=0,this._isComeDown=!1,this.prompt.text="长按屏幕开始游戏",this.count.text="得分：0",this.floors.removeChildren(),this.floors.x=0,this._character.y=500,this._init(),this._move()},o.prototype._generateFloors=function(t){for(var e=this.floors,n=this._currentMartix;n<t.length;n++){var i=t[n],r=this._getLocate(i),o=this._getFloorItem(r);e.addChild(o)}},o.prototype._getLocate=function(t){var e=this._getLocalPoint(t[0]),n=this._getLocalPoint(t[1]-t[0]);return{x:e,width:n}},o.prototype._getLocalPoint=function(t){var e=cm.main.stage.stageWidth,n=e/100;return t*n},o.prototype._getFloorItem=function(t){var e=t.x,n=t.width,i=new eui.Image;return i.x=e,i.width=n,i.height=500,i.bottom=0,i.source="main_json.widget",i.scale9Grid=new egret.Rectangle(41,43,11,7),i},o.prototype._addCharacter=function(){if(!this._character){var e=this._character=new t.Character("xiaocha","");e.randomPlayWhenIdle({actions:["yawn","hello"],interval:1e3,rate:.05}),e.setDirection(t.CharacterDirection.RIGHT),e.x=n/2,this.line.x=e.x+40,e.y=500,this.grounds.addChild(e),this.grounds.setChildIndex(e,0),e.callback=this._move.bind(this)}},o.prototype._addTouchHandler=function(){return this._touchCapture?this._enableTouchHandler():(this._touchCapture=new modle.TouchCapture,this._touchCapture.bindNode(this),void this._enableTouchHandler())},o.prototype._enableTouchHandler=function(){this._touchCapture&&(this._touchCapture.addEventListener(modle.TouchCaptureEvent.ON_PROGRESS,this._onLineProgressHandler,this),this._touchCapture.addEventListener(modle.TouchCaptureEvent.ON_COMPLETE,this._rotationLine,this))},o.prototype._disableTouchHandler=function(){this._touchCapture&&(this._touchCapture.removeEventListener(modle.TouchCaptureEvent.ON_PROGRESS,this._onLineProgressHandler,this),this._touchCapture.removeEventListener(modle.TouchCaptureEvent.ON_COMPLETE,this._rotationLine,this))},o.prototype._onLineProgressHandler=function(t){var n=t.data,i=Math.round(this._getLocalPoint(n*e));this.line.height=i},o.prototype._rotationLine=function(t){var e=this;this._disableTouchHandler();var n=t.data;this.line.rotation=-180,egret.Tween.get(this.line).to({rotation:-90},500).call(function(){e._currentPosition+=1,e._currentPoint=e._getTargetPoint(n),e._move()},this)},o.prototype._getTargetPoint=function(t){var n=this._currentPoint+Math.floor(t*e),i=this._martixFloor.getMartix(),r=i[this._currentPosition],o=r[0],a=r[1];return n>o&&a>n?n=a:this._isComeDown=!0,n},o.prototype._move=function(){var t=this,e=this._getLocalPoint(this._currentPoint),r=this.floors.x,o=-e+n;this._character.walk(),egret.Tween.get(this.line).to({x:o-r},100*Math.abs(r-o)/i).call(function(){t._isComeDown||(t.line.x=t._character.x+40)}),egret.Tween.get(this.floors).to({x:o},100*Math.abs(r-o)/i).call(function(){return t._isComeDown?void t._comeDown():(t._currentPosition>0&&t._addCount(),void t._clear())})},o.prototype._comeDown=function(){var t=this;this.prompt.text="您已坠落，游戏结束\n\n点击屏幕重新开始",this._character.idle(),egret.Tween.get(this._character).to({y:1500},1e3).call(function(){t.once(egret.TouchEvent.TOUCH_END,t._reStart,t)})},o.prototype._addCount=function(){this._count+=10,this.count.text="得分："+this._count},o.prototype._clear=function(){this._character.idle(),this.line.x=this._character.x+40,this.line.rotation=0,this.line.height=0,this._enableTouchHandler();var t=this._martixFloor.getMartix().length,e=this._currentPosition;if(5>t-e){var n=this._martixFloor.addMartix(10);this._generateFloors(n)}},o}(cm.BaseScene);t.MainScene=r,__reflect(r.prototype,"views.MainScene")}(views||(views={}));